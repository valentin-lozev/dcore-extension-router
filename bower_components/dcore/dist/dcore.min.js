/**
 *  @license dcore.js
 *  Copyright Â© 2017 Valentin Lozev
 *  Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
 *  Source code: http://github.com/valentin-lozev/dcore
 */
var dcore;!function(dcore){"use strict";var DefaultSandbox=function(){function DefaultSandbox(core,moduleId,moduleInstanceId){if(!core||!moduleId||!moduleInstanceId)throw new Error("DefaultSandbox: Missing core or module instance ID");this.core=core,this.moduleId=moduleId,this.moduleInstanceId=moduleInstanceId}return DefaultSandbox.prototype.subscribe=function(topics,handler){return this.core.subscribe(topics,handler)},DefaultSandbox.prototype.publish=function(topic,data){return this.core.publish(topic,data),this},DefaultSandbox.prototype.start=function(moduleId,options){return this.core.start(moduleId,options),this},DefaultSandbox.prototype.stop=function(moduleId,instanceId){return this.core.stop(moduleId,instanceId),this},DefaultSandbox}();dcore.DefaultSandbox=DefaultSandbox}(dcore||(dcore={}));var dcore;!function(dcore){"use strict";function typeGuard(expected,value,errorMsg){var toThrow=!1;switch(expected){case"array":toThrow=!Array.isArray(value);break;default:toThrow=typeof value!==expected||null===value}if(toThrow)throw new TypeError(errorMsg)}function runPlugins(hookType){for(var params=[],_i=1;_i<arguments.length;_i++)params[_i-1]=arguments[_i];if(!this.state.isRunning)throw new Error("runPlugins(): Core is not running");var plugins=this.hooks[hookType];if(!Array.isArray(plugins))return!0;for(var argumentsLength=arguments.length,args=new Array(argumentsLength-1),i=1;i<argumentsLength;i++)args[i-1]=arguments[i];for(var i=0,len=plugins.length;i<len;i++)try{if(!plugins[i].apply(null,args))return!1}catch(err){var argsDetails=args.length>0?args.join(", "):"none";console.error("runPlugins(): Execution failed on hook "+hookType),console.error("runPlugins(): Execution arguments: "+argsDetails),console.error("runPlugins(): Error: "+err)}return!0}function addSubscriber(topic,handler){hasOwnProperty.call(this.subscribers,topic)||(this.subscribers[topic]={});var subscriptionID="sbscrptn"+ ++lastUsedSubscriptionID;return this.subscribers[topic][subscriptionID]=handler,subscriptionID}function createOne(sandboxType,isDebug){return void 0===isDebug&&(isDebug=!0),new Instance(sandboxType,isDebug)}var hasOwnProperty=Object.prototype.hasOwnProperty,lastUsedSubscriptionID=0;dcore.HOOK_DOM_READY="dom-ready",dcore.HOOK_MODULE_DESTROY="module-destroy",dcore.HOOK_MODULE_DESTROYED="module-destroyed",dcore.HOOK_MODULE_INITIALIZE="module-init",dcore.HOOK_MODULE_INITIALIZED="module-initialized",dcore.HOOK_MODULE_REGISTER="module-register",dcore.HOOK_MODULE_REGISTERED="module-registered",dcore.HOOK_MODULE_PUBLISH="module-publish",dcore.HOOK_MODULE_SUBSCRIBE="module-subscribe",dcore.HOOK_MODULE_UNSUBSCRIBE="module-unsubscribe";var Instance=function(){function Instance(sandboxType,isDebug){void 0===isDebug&&(isDebug=!0),this.subscribers={},this.modules={},this.hooks={},this.Sandbox="function"==typeof sandboxType?sandboxType:dcore.DefaultSandbox,this.state={isDebug:!!isDebug,isRunning:!1}}return Instance.prototype.subscribe=function(topics,handler){var errorMsg="subscribe() failed:";if(typeGuard("function",handler,errorMsg+" message handler should be a function."),typeGuard("array",topics,errorMsg+" topics should be passed as an array of strings."),!runPlugins.call(this,dcore.HOOK_MODULE_SUBSCRIBE,topics))return{destroy:function(){}};for(var token={},i=0,len=topics.length;i<len;i++){var topic=topics[i],subscriptionID=addSubscriber.call(this,topic,handler);token[topic]=subscriptionID}var that=this;return{destroy:function(topic){if(0===arguments.length)return void Object.keys(token).forEach(function(t){runPlugins.call(that,dcore.HOOK_MODULE_UNSUBSCRIBE,t);var subscriptionID=token[t];delete that.subscribers[t][subscriptionID]});if(hasOwnProperty.call(token,topic)){runPlugins.call(that,dcore.HOOK_MODULE_UNSUBSCRIBE,topic);var subscriptionID=token[topic];delete that.subscribers[topic][subscriptionID]}}}},Instance.prototype.publish=function(topic,data){if(!hasOwnProperty.call(this.subscribers,topic))return this;if(!runPlugins.call(this,dcore.HOOK_MODULE_PUBLISH,topic,data))return this;var subscriptions=this.subscribers[topic];return Object.keys(subscriptions).forEach(function(key){var handler=subscriptions[key];try{setTimeout(function(){return handler(topic,data)},0)}catch(ex){setTimeout(function(){console.info(topic+" message publishing failed. Subscriber:"),console.info(handler)},0)}}),this},Instance.prototype.register=function(moduleId,moduleFactory){var errorMsg="register() failed:";typeGuard("string",moduleId,errorMsg+" module ID must be a string - "+moduleId),typeGuard("undefined",this.modules[moduleId],errorMsg+" module with such id has been already registered - "+moduleId);var tempModule=moduleFactory(new this.Sandbox(this,moduleId,moduleId));return typeGuard("function",tempModule.init,errorMsg+" module does not implement init method"),typeGuard("function",tempModule.destroy,errorMsg+" module does not implement destroy method"),runPlugins.call(this,dcore.HOOK_MODULE_REGISTER,moduleId,moduleFactory)?(this.modules[moduleId]={create:moduleFactory,instances:{}},runPlugins.call(this,dcore.HOOK_MODULE_REGISTERED,moduleId,moduleFactory),this):this},Instance.prototype.start=function(moduleId,options){var module=this.modules[moduleId];options=options||{};var errorMsg="start() failed:";typeGuard("object",module,errorMsg+" module not found - "+moduleId),typeGuard("object",options,errorMsg+" module options must be an object");var instanceId=options.instanceId||moduleId;if(hasOwnProperty.call(module.instances,instanceId))return this;if(!runPlugins.call(this,dcore.HOOK_MODULE_INITIALIZE,moduleId,options))return this;var instance=module.create(new this.Sandbox(this,moduleId,instanceId));return module.instances[instanceId]=instance,instance.init(options),runPlugins.call(this,dcore.HOOK_MODULE_INITIALIZED,moduleId,options),this},Instance.prototype.stop=function(moduleId,instanceId){var module=this.modules[moduleId],id=instanceId||moduleId;if(module&&hasOwnProperty.call(module.instances,id)){if(!runPlugins.call(this,dcore.HOOK_MODULE_DESTROY,moduleId,instanceId))return this;try{module.instances[id].destroy(),runPlugins.call(this,dcore.HOOK_MODULE_DESTROYED,moduleId,instanceId)}catch(err){console.warn(moduleId+" destroy failed: An error has occured within the module:"),console.error(err)}finally{delete module.instances[id]}}else console.warn(moduleId+" destroy failed: "+instanceId+" instance not found.");return this},Instance.prototype.listModules=function(){return Object.keys(this.modules)},Instance.prototype.hook=function(hookType,plugin){var errorMsg="hook() failed:";return typeGuard("string",hookType,errorMsg+" hook type should be a string"),typeGuard("function",plugin,errorMsg+" plugin should be a function"),Array.isArray(this.hooks[hookType])||(this.hooks[hookType]=[]),this.hooks[hookType].push(plugin),this},Instance.prototype.run=function(action){if(!this.state.isRunning)return this.beforeRunAction=action,this._onDomReady=this._onDomReady.bind(this),"complete"===document.readyState||"interactive"===document.readyState||"loaded"===document.readyState?this._onDomReady(null):document.addEventListener("DOMContentLoaded",this._onDomReady),this},Instance.prototype._onDomReady=function(ev){document.removeEventListener("DOMContentLoaded",this._onDomReady),this.state.isRunning=!0,"function"==typeof this.beforeRunAction&&this.beforeRunAction(),runPlugins.call(this,dcore.HOOK_DOM_READY)},Instance}();dcore.Instance=Instance,dcore.createOne=createOne}(dcore||(dcore={}));