/**
 *  @license dcore.js
 *  Copyright Â© 2017 Valentin Lozev
 *  Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
 *  Source code: http://github.com/valentin-lozev/dcore
 */
"function"!=typeof Object.assign&&(Object.assign=function(target,varArgs){"use strict";if(null==target)throw new TypeError("Cannot convert undefined or null to object");for(var to=Object(target),index=1;index<arguments.length;index++){var nextSource=arguments[index];if(null!=nextSource)for(var nextKey in nextSource)Object.prototype.hasOwnProperty.call(nextSource,nextKey)&&(to[nextKey]=nextSource[nextKey])}return to}),"function"!=typeof Array.prototype.reduceRight&&(Array.prototype.reduceRight=function(callback){"use strict";if(null===this||"undefined"==typeof this)throw new TypeError("Array.prototype.reduce called on null or undefined");if("function"!=typeof callback)throw new TypeError(callback+" is not a function");var value,t=Object(this),len=t.length>>>0,k=len-1;if(arguments.length>=2)value=arguments[1];else{for(;k>=0&&!(k in t);)k--;if(k<0)throw new TypeError("Reduce of empty array with no initial value");value=t[k--]}for(;k>=0;k--)k in t&&(value=callback(value,t[k],k,t));return value});var dcore;!function(dcore){var _private;!function(_private){"use strict";function argumentGuard(errorMsgPrefix){return void 0===errorMsgPrefix&&(errorMsgPrefix=""),new DArgumentGuard(errorMsgPrefix)}var DArgumentGuard=function(){function DArgumentGuard(errorMsgPrefix){void 0===errorMsgPrefix&&(errorMsgPrefix=""),this.errorMsgPrefix=errorMsgPrefix}return DArgumentGuard.prototype.mustBeTrue=function(arg,msg){if(!arg)throw new Error(this.errorMsgPrefix+msg);return this},DArgumentGuard.prototype.mustBeDefined=function(arg,msg){if("undefined"==typeof arg||null===arg)throw new Error(this.errorMsgPrefix+msg);return this},DArgumentGuard.prototype.mustBeUndefined=function(arg,msg){if("undefined"!=typeof arg&&null!==arg)throw new Error(this.errorMsgPrefix+msg);return this},DArgumentGuard.prototype.mustBeNonEmptyString=function(arg,msg){if("string"!=typeof arg||!arg.length)throw new Error(this.errorMsgPrefix+msg);return this},DArgumentGuard.prototype.mustBeFunction=function(arg,msg){if("function"!=typeof arg)throw new Error(this.errorMsgPrefix+msg);return this},DArgumentGuard.prototype.mustBeArray=function(arg,msg){if(!Array.isArray(arg))throw new Error(this.errorMsgPrefix+msg);return this},DArgumentGuard}();_private.argumentGuard=argumentGuard}(_private=dcore._private||(dcore._private={}))}(dcore||(dcore={}));var dcore;!function(dcore){var _private;!function(_private){"use strict";var hasOwnProperty=Object.prototype.hasOwnProperty,lastUsedSubscriptionID=0,DMessagesAggregator=function(){function DMessagesAggregator(){this.subscribers={}}return DMessagesAggregator.prototype.subscribe=function(topics,handler){var _this=this;_private.argumentGuard("subscribe(): ").mustBeFunction(handler,"message handler should be a function.").mustBeArray(topics,"topics should be passed as an array of strings.");var token={};topics.forEach(function(topic){return token[topic]=_this.__addSubscriber(topic,handler)});var that=this;return{destroy:function(topic){return arguments.length>0?void that.__unsubscribe(topic,token):void Object.keys(token).forEach(function(topic){return that.__unsubscribe(topic,token)})}}},DMessagesAggregator.prototype.publish=function(topic,message){if(hasOwnProperty.call(this.subscribers,topic)){var subscriptions=this.subscribers[topic];Object.keys(subscriptions).forEach(function(key){var handler=subscriptions[key];setTimeout(function(){try{handler(topic,message)}catch(err){console.error('publish(): Receive "'+topic+'" message failed.'),console.error(err),console.error("Handler:"),console.error(handler)}},0)})}},DMessagesAggregator.prototype.__addSubscriber=function(topic,handler){hasOwnProperty.call(this.subscribers,topic)||(this.subscribers[topic]={});var subscriptionID="sbscrptn"+ ++lastUsedSubscriptionID;return this.subscribers[topic][subscriptionID]=handler,subscriptionID},DMessagesAggregator.prototype.__unsubscribe=function(topic,token){if(hasOwnProperty.call(token,topic)){var subscriptionID=token[topic];delete this.subscribers[topic][subscriptionID]}},DMessagesAggregator}();_private.DMessagesAggregator=DMessagesAggregator}(_private=dcore._private||(dcore._private={}))}(dcore||(dcore={}));var dcore;!function(dcore){var _private;!function(_private){"use strict";var DPluginsPipeline=function(){function DPluginsPipeline(){this.pluginsMap={}}return DPluginsPipeline.prototype.hook=function(hookName,plugin){_private.argumentGuard("hook(): ").mustBeNonEmptyString(hookName,"hook name must be a non empty string").mustBeFunction(plugin,"plugin must be a function");var list=this.pluginsMap[hookName];list||(this.pluginsMap[hookName]=list=[]),list.push(plugin)},DPluginsPipeline.prototype.pipe=function(hookName,hookInvoker,hookContext){for(var args=[],_i=3;_i<arguments.length;_i++)args[_i-3]=arguments[_i];_private.argumentGuard("pipe(): ").mustBeFunction(hookInvoker,"hook invoker must be a function");var pipeline=(this.pluginsMap[hookName]||[]).slice(0).reduceRight(function(next,pipeline){return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return pipeline.apply(this,[next].concat(args))}},hookInvoker),result=pipeline.apply(hookContext,args);return pipeline=null,result},DPluginsPipeline}();_private.DPluginsPipeline=DPluginsPipeline}(_private=dcore._private||(dcore._private={}))}(dcore||(dcore={}));var dcore;!function(dcore){var hooks;!function(hooks){"use strict";hooks.SANDBOX_SUBSCRIBE="sandbox.subscribe",hooks.SANDBOX_PUBLISH="sandbox.publish",hooks.SANDBOX_START="sandbox.start",hooks.SANDBOX_STOP="sandbox.stop"}(hooks=dcore.hooks||(dcore.hooks={}))}(dcore||(dcore={})),function(dcore){"use strict";var _privateData=dcore._private,Sandbox=function(){function Sandbox(core,moduleId,moduleInstanceId){_privateData.argumentGuard("DefaultSandbox: ").mustBeDefined(core,"core must be provided").mustBeNonEmptyString(moduleId,"module id must be a non empty string").mustBeNonEmptyString(moduleInstanceId,"module instance id must be a non empty string"),this.core=core,this.moduleId=moduleId,this.moduleInstanceId=moduleInstanceId}return Sandbox.prototype.getModuleId=function(){return this.moduleId},Sandbox.prototype.getModuleInstanceId=function(){return this.moduleInstanceId},Sandbox.prototype.getAppState=function(){return this.core.getState()},Sandbox.prototype.setAppState=function(value){this.core.setState(value)},Sandbox.prototype.subscribe=function(topics,handler){return this.core.pipe(dcore.hooks.SANDBOX_SUBSCRIBE,this.__subscribe,this,Array.isArray(topics)?topics:[topics],handler)},Sandbox.prototype.publish=function(topic,message){this.core.pipe(dcore.hooks.SANDBOX_PUBLISH,this.__publish,this,topic,message)},Sandbox.prototype.start=function(moduleId,props){this.core.pipe(dcore.hooks.SANDBOX_START,this.__start,this,moduleId,props)},Sandbox.prototype.stop=function(moduleId,instanceId){this.core.pipe(dcore.hooks.SANDBOX_STOP,this.__stop,this,moduleId,instanceId)},Sandbox.prototype.__subscribe=function(topics,handler){return this.core.subscribe(topics,handler)},Sandbox.prototype.__publish=function(topic,message){this.core.publish(topic,message)},Sandbox.prototype.__start=function(moduleId,props){this.core.start(moduleId,props)},Sandbox.prototype.__stop=function(moduleId,instanceId){this.core.stop(moduleId,instanceId)},Sandbox}();dcore.Sandbox=Sandbox}(dcore||(dcore={}));var dcore;!function(dcore){"use strict";function isDocumentReady(){return"complete"===document.readyState||"interactive"===document.readyState||"loaded"===document.readyState}var _privateData=dcore._private;delete dcore._private;var hooks;!function(hooks){hooks.CORE_REGISTER="core.register",hooks.CORE_RUN="core.run",hooks.MODULE_INIT="module.init",hooks.MODULE_DESTROY="module.destroy"}(hooks=dcore.hooks||(dcore.hooks={}));var hasOwnProperty=Object.prototype.hasOwnProperty,Application=function(){function Application(isDebug){void 0===isDebug&&(isDebug=!0),this.modules={},this.Sandbox=dcore.Sandbox,this.pluginsPipeline=new _privateData.DPluginsPipeline,this.messagesAggregator=new _privateData.DMessagesAggregator,this.state={isDebug:isDebug,isRunning:!1}}return Application.prototype.getState=function(){return Object.assign({},this.state)},Application.prototype.setState=function(value){"object"==typeof value&&(value.isRunning=this.state.isRunning,value.isDebug=this.state.isDebug,this.state=Object.assign({},this.state,value))},Application.prototype.subscribe=function(topics,handler){return this.messagesAggregator.subscribe(topics,handler)},Application.prototype.publish=function(topic,message){this.messagesAggregator.publish(topic,message)},Application.prototype.register=function(moduleId,moduleFactory){_privateData.argumentGuard("register(): ").mustBeNonEmptyString(moduleId,"module id must be a non empty string").mustBeUndefined(this.modules[moduleId],"module with such id has been already registered - "+moduleId);var tempModule=moduleFactory(new this.Sandbox(this,moduleId,moduleId));_privateData.argumentGuard("register(): ").mustBeFunction(tempModule.init,"module must implement init method").mustBeFunction(tempModule.destroy,"module must implement destroy method"),this.pluginsPipeline.pipe(hooks.CORE_REGISTER,this.__register,this,moduleId,moduleFactory)},Application.prototype.start=function(moduleId,props){var moduleData=this.modules[moduleId];_privateData.argumentGuard("start(): ").mustBeDefined(moduleData,"module not found - "+moduleId);var instanceId=props&&props.instanceId?props.instanceId:moduleId,alreadyInitialized=hasOwnProperty.call(moduleData.instances,instanceId);if(!alreadyInitialized)try{this.__startModule(moduleId,instanceId,moduleData,props)}catch(err){delete moduleData.instances[instanceId],console.error('start(): "'+moduleId+'" instance init failed'),console.error(err)}},Application.prototype.stop=function(moduleId,instanceId){var moduleData=this.modules[moduleId],id=instanceId||moduleId;if(!moduleData||!hasOwnProperty.call(moduleData.instances,id))return void console.warn('stop(): "'+moduleId+'" destroy failed. "'+instanceId+'" instance not found.');var instance=moduleData.instances[id];try{this.pluginsPipeline.pipe(hooks.MODULE_DESTROY,instance.destroy,instance)}catch(err){console.error('stop(): "'+moduleId+'" destroy failed. An error has occured within the module'),console.error(err)}finally{delete moduleData.instances[id],instance=null}},Application.prototype.listModules=function(){return Object.keys(this.modules)},Application.prototype.hook=function(hookName,plugin){this.pluginsPipeline.hook(hookName,plugin)},Application.prototype.pipe=function(hookName,hookInvoker,hookContext){for(var args=[],_i=3;_i<arguments.length;_i++)args[_i-3]=arguments[_i];return this.pluginsPipeline.pipe.apply(this.pluginsPipeline,[hookName,hookInvoker,hookContext].concat(args))},Application.prototype.run=function(onRunCallback){this.state.isRunning||(this.onApplicationRun=onRunCallback,isDocumentReady()?this.__onDomReady(null):(this.__onDomReady=this.__onDomReady.bind(this),document.addEventListener("DOMContentLoaded",this.__onDomReady)))},Application.prototype.__onDomReady=function(ev){if(document.removeEventListener("DOMContentLoaded",this.__onDomReady),this.state.isRunning=!0,"function"==typeof this.onApplicationRun)try{this.onApplicationRun()}catch(err){console.error("run(): onRunCallback failed"),console.error(err)}delete this.onApplicationRun,this.pluginsPipeline.pipe(hooks.CORE_RUN,function(){},this)},Application.prototype.__register=function(moduleId,moduleFactory){this.modules[moduleId]={create:moduleFactory,instances:{}}},Application.prototype.__startModule=function(moduleId,instanceId,moduleData,props){props=props||{instanceId:instanceId};var sb=new this.Sandbox(this,moduleId,instanceId),instance=moduleData.create(sb);moduleData.instances[instanceId]=instance,this.pluginsPipeline.pipe(hooks.MODULE_INIT,function(){instance.init(props),instance=null},instance,props,sb)},Application}();dcore.Application=Application}(dcore||(dcore={}));