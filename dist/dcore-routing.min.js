var dcore;!function(dcore){!function(routing){"use strict";function hasQuery(queryIndex){return queryIndex>-1}function extractQueryParams(url,queryIndex){return hasQuery(queryIndex)?url.substring(queryIndex+1).split("&").map(extractQueryParam):[]}function extractQueryParam(keyValuePair){var args=keyValuePair.split("=");return{key:args[0],value:args[1]||""}}function extractTokens(url,queryIndex){return urlWithoutQuery(url,queryIndex).split("/").filter(function(token){return""!==token})}function urlWithoutQuery(url,queryIndex){return hasQuery(queryIndex)?url.substring(0,url.length-(url.length-queryIndex)):url}var UrlHash=function(){function UrlHash(){this.tokens=[],this.queryParams=[],this.__url=""}return Object.defineProperty(UrlHash.prototype,"url",{get:function(){return this.__url},set:function(url){url=url||"";var queryIndex=url.indexOf("?");this.__url=url,this.queryParams=extractQueryParams(url,queryIndex),this.tokens=extractTokens(url,queryIndex)},enumerable:!0,configurable:!0}),UrlHash}();routing.UrlHash=UrlHash}(dcore.routing||(dcore.routing={}))}(dcore||(dcore={}));var dcore;!function(dcore){!function(routing){"use strict";var routeParamRegex=/{([a-zA-Z]+)}/,Route=function(){function Route(pattern,onStart){this.tokens=[];var errorMsg="Route registration failed:";if("string"!=typeof pattern)throw new TypeError(errorMsg+" pattern should be non empty string.");if("function"!=typeof onStart)throw new TypeError(errorMsg+" callback should be a function.");this.params={},this.pattern=pattern,this.callback=onStart,this.populateTokens()}return Route.prototype.getTokens=function(){return this.tokens.slice(0)},Route.prototype.matches=function(hashUrl){if(this.tokens.length!==hashUrl.tokens.length)return!1;for(var i=0,len=this.tokens.length;i<len;i++){var token=this.tokens[i],urlToken=hashUrl.tokens[i];if(!token.isDynamic&&token.name.toLowerCase()!==urlToken.toLowerCase())return!1}return!0},Route.prototype.start=function(urlHash){if(this.params=this.extractRotueParams(urlHash),this.callback)try{this.callback(this.params,this.pattern)}catch(error){console.error("Couldn't start "+urlHash.url+" route due to:"),console.error(error)}},Route.prototype.populateTokens=function(){var _this=this;this.tokens=[],this.pattern.split("/").forEach(function(urlFragment){""!==urlFragment&&_this.tokens.push(_this.parseToken(urlFragment))})},Route.prototype.parseToken=function(urlFragment){var paramMatchGroups=routeParamRegex.exec(urlFragment),isDynamic=!!paramMatchGroups;return{name:isDynamic?paramMatchGroups[1]:urlFragment,isDynamic:isDynamic}},Route.prototype.extractRotueParams=function(url){return this.tokens.reduce(function(prevResult,token,index){return token.isDynamic&&(prevResult[token.name]=url.tokens[index]),prevResult},this.extractQueryParams(url))},Route.prototype.extractQueryParams=function(url){return url.queryParams.reduce(function(prevResult,param){return prevResult[param.key]=param.value,prevResult},{})},Route}();routing.Route=Route}(dcore.routing||(dcore.routing={}))}(dcore||(dcore={}));var dcore;!function(dcore){"use strict";var hooks,plugin=dcore.routing;!function(hooks){hooks.ROUTING_REGISTER="routing.register",hooks.ROUTING_START="routing.start"}(hooks=dcore.hooks||(dcore.hooks={}));var Routing=function(){function Routing(core){this.defaultUrl=null,this.routes=[],this.urlHash=new plugin.UrlHash,this.core=core}return Routing.prototype.register=function(pattern,callback){if(this.routes.some(function(r){return r.pattern===pattern}))throw new Error("register(): Route "+pattern+" has been already registered.");this.core.pipeline.pipe(hooks.ROUTING_REGISTER,this.__register,this,pattern,callback)},Routing.prototype.startRoute=function(hash){this.core.pipeline.pipe(hooks.ROUTING_START,this.__startRoute,this,hash)},Routing.prototype.current=function(){return{pattern:this.currentRoute?this.currentRoute.pattern:null,params:this.currentRoute?this.currentRoute.params:null}},Routing.prototype.patterns=function(){return this.routes.map(function(route){return route.pattern})},Routing.prototype.any=function(){return this.routes.length>0},Routing.prototype.__register=function(pattern,callback){this.routes.push(new plugin.Route(pattern,callback))},Routing.prototype.__startRoute=function(hash){if(this.urlHash.url=hash,this.currentRoute=this.__findRoute(),this.currentRoute)return void this.currentRoute.start(this.urlHash);"string"==typeof this.defaultUrl?this.__startDefaultRoute(hash):console.warn("No route matches "+hash)},Routing.prototype.__findRoute=function(){for(var i=0,len=this.routes.length;i<len;i++){var route=this.routes[i];if(route.matches(this.urlHash))return route}return null},Routing.prototype.__startDefaultRoute=function(invalidHash){window.history.replaceState(null,null,window.location.pathname+"#"+this.defaultUrl),this.urlHash.url=this.defaultUrl,this.currentRoute=this.__findRoute(),this.currentRoute?this.currentRoute.start(this.urlHash):console.warn("No route handler for "+invalidHash)},Routing}();dcore.Routing=Routing}(dcore||(dcore={}));var dcore;!function(dcore){"use strict";function sandboxGetCurrentRoute(){return this.core.routing.current()}function sandboxGo(hash){location.hash=hash}function handleRoute(){this.routing.startRoute(window.location.hash.substring(1))}function runRouting(next){next(),this.routing.any()&&(window.addEventListener("hashchange",handleRoute.bind(this)),handleRoute.call(this))}dcore.Application.prototype.useRouting=function(){return this.routing||(this.routing=new dcore.Routing(this),function(sb){sb.getCurrentRoute=sandboxGetCurrentRoute,sb.go=sandboxGo}(this.Sandbox.prototype),this.pipeline.hook(dcore.hooks.CORE_RUN,runRouting)),this}}(dcore||(dcore={}));