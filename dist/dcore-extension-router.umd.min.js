!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define(["exports"],factory):factory(global["dcore-extension-router"]={})}(this,function(exports){"use strict";function parseSearchPair(keyValuePair){var args=keyValuePair.split("=");return{key:args[0],value:args[1]||""}}function createTokens(path){return path.split("/").reduce(function(prevResult,hashFragment){return""!==hashFragment&&prevResult.push(function(hashFragment){var paramMatchGroups=routeParamRegex.exec(hashFragment),isDynamic=!!paramMatchGroups;return{name:isDynamic?paramMatchGroups[1]:hashFragment,isDynamic:isDynamic}}(hashFragment)),prevResult},[])}function matchedRoute(){return this._extensionsOnlyCore.router.current}function onCoreInitPlugin(next){var _this=this;next(),window.addEventListener("hashchange",function(){return _this.router.start(window.location.hash)}),this.router.start(window.location.hash)}var Hash=function(){function Hash(){this._value="",this._searchParams=[],this._tokens=[]}return Object.defineProperty(Hash.prototype,"value",{get:function(){return this._value},set:function(hash){var searchIndex=(hash="#"!==(hash=hash||"")[0]?hash:hash.substring(1)).indexOf("?");this._value=hash,this._searchParams=function(hash,searchIndex){return searchIndex<0?[]:hash.substring(searchIndex+1).split("&").map(parseSearchPair)}(hash,searchIndex),this._tokens=function(hash,searchIndex){return function(hash,searchIndex){return searchIndex<0?hash:hash.substring(0,searchIndex)}(hash,searchIndex).split("/").filter(function(token){return""!==token})}(hash,searchIndex)},enumerable:!0,configurable:!0}),Object.defineProperty(Hash.prototype,"tokens",{get:function(){return this._tokens.slice(0)},enumerable:!0,configurable:!0}),Object.defineProperty(Hash.prototype,"search",{get:function(){return this._searchParams.slice(0)},enumerable:!0,configurable:!0}),Hash}(),routeParamRegex=/{([a-zA-Z]+)}/,Route=function(){function Route(path,callback){if(this._tokens=[],"string"!=typeof path||""===path)throw new TypeError("route(): path should be non empty string.");if("function"!=typeof callback)throw new TypeError("route(): callback should be a function.");this.params=Object.create(null),this.path=path,this.callback=callback,this._tokens=createTokens(this.path)}return Object.defineProperty(Route.prototype,"tokens",{get:function(){return this._tokens.slice(0)},enumerable:!0,configurable:!0}),Route.prototype.matches=function(hash){if(this._tokens.length!==hash.tokens.length)return!1;for(var i=0,len=this._tokens.length;i<len;i++){var token=this._tokens[i],urlToken=hash.tokens[i];if(!token.isDynamic&&token.name.toLowerCase()!==urlToken.toLowerCase())return!1}return!0},Route.prototype.start=function(hash){if(this.params=this.parseParams(hash),this.callback)try{this.callback({path:this.path,params:this.params})}catch(error){console.error("start(): Couldn't start \""+hash.value+'" hash'),console.error(error)}},Route.prototype.parseParams=function(hash){return this._tokens.reduce(function(prevResult,token,index){return token.isDynamic&&(prevResult[token.name]=hash.tokens[index]),prevResult},function(hash){return hash.search.reduce(function(prevResult,param){return prevResult[param.key]=param.value,prevResult},Object.create(null))}(hash))},Route}(),Router=function(){function Router(dcore){this.defaultHash=null,this.routes=Object.create(null),this.hash=new Hash,this.currentRoute=null,this.route=dcore.createHook("onRouteAdd",this.route,this),this.start=dcore.createHook("onRouteStart",this.start,this)}return Object.defineProperty(Router.prototype,"paths",{get:function(){return Object.keys(this.routes)},enumerable:!0,configurable:!0}),Object.defineProperty(Router.prototype,"current",{get:function(){var current=this.currentRoute;return{path:current?current.path:null,params:current?current.params:null}},enumerable:!0,configurable:!0}),Router.prototype.route=function(path,onStart){if(path in this.routes)throw new Error("route(): "+path+" has already been added");this.routes[path]=new Route(path,onStart)},Router.prototype.start=function(hash){this.hash.value=hash,this.currentRoute=this.__findRoute(),this.currentRoute?this.currentRoute.start(this.hash):"string"==typeof this.defaultHash?this.__startDefaultRoute(hash):console.warn("start(): No route matches "+hash)},Router.prototype.__findRoute=function(){for(var paths=this.paths,i=0,len=paths.length;i<len;i++){var path=paths[i],route=this.routes[path];if(route.matches(this.hash))return route}return null},Router.prototype.__startDefaultRoute=function(hash){window.history.replaceState(null,null,window.location.pathname+"#"+this.defaultHash),this.hash.value=this.defaultHash,this.currentRoute=this.__findRoute(),this.currentRoute?this.currentRoute.start(this.hash):console.warn("start(): No route handler for "+hash)},Router}();exports.router=function(){return{name:"router",install:function(dcore){return function(dcore,sandbox){dcore.router=new Router(dcore),sandbox.matchedRoute=matchedRoute}(dcore,dcore.Sandbox.prototype),{onCoreInit:onCoreInitPlugin}}}},Object.defineProperty(exports,"__esModule",{value:!0})});
